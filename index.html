<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <meta http-equiv="X-UA-Compatible" content="ie=edge">
   <title>GH</title>
</head>
<body>
   <div class="settings">
      <strong>Enter Abstract Count (1 - 20):</strong>
      <input type="number" value="4" oninput="if(this.value < 1){this.value=1;} if(this.value > 20){this.value=20;}">
      <input type="file" accept="image/gif, image/jpeg, image/png">
      <button onclick="go();">Go!</button>
   </div>
   <canvas></canvas>
   <script>
   
   function go(){
      var image = new Image();
      var reader = new FileReader();
      reader.onload = function(e){
         image.src = e.target.result;
      }
      reader.readAsDataURL(document.querySelector("input[type=file]").files[0]);
      image.onload = function() {
         algorithm(image);
      }
   }
   function algorithm(image_data){
      var image = document.createElement('canvas');
      image.width = 180;
      image.height = 180 * (image_data.height / image_data.width);
      var image_context = image.getContext('2d');
      image_context.drawImage(image_data, 0, 0, image.width, image.height);
      var imageData = image_context.getImageData(0, 0, image.width, image.height);
      
      var canvas = document.querySelector("canvas");
      canvas.width = image.width*5;
      canvas.height = image.height*5;
      var context = canvas.getContext("2d");

      var usedIndeces = [];

      function magicWand(index, rgba, direction){
         var index_rgba = [imageData.data[index], imageData.data[index + 1], imageData.data[index + 2], imageData.data[index + 3]];

         var diff = Math.abs(rgba[0] - index_rgba[0]) + Math.abs(rgba[1] - index_rgba[1]) + Math.abs(rgba[2] - index_rgba[2]);

         if(usedIndeces.indexOf(index) <= -1 && diff < (document.querySelector("input[type=number]").value * 10) && indexOfMax(rgba) == indexOfMax(index_rgba)){
            usedIndeces.push(index);
            x = ((index / 4) % image.width) * 5;
            y = Math.floor((index / 4) / image.width) * 5;

            context.fillStyle = `rgba(${rgba.join(",")})`;
            context.fillRect(x, y, 5, 5);

            if((index + 4) / 4 < image.width && direction != "left"){
               try{
                  magicWand(index+4, rgba, "right");
               }catch{}
            }
            if(index > 0 && direction != "right"){
               try{
                  magicWand(index-4, rgba, "left");
               }catch{}
            }
            if(index - (4 * image.width) >= 0 && direction != "down"){
               try{
                  magicWand(index - (4 * image.width), rgba, "up");
               }catch{}
            }
            if(index + (4 * image.width) < imageData.data.length && direction != "up"){
               try{
                  magicWand(index + (4 * image.width), rgba, "down");
               }catch{}
            }
         }
      }

      for(var index = 0;index < imageData.data.length;index += 4){
         magicWand(index, [imageData.data[index], imageData.data[index + 1], imageData.data[index + 2], imageData.data[index + 3]]);
      }
   }
   function indexOfMax(arr) {
      if (arr.length === 0) {
         return -1;
      }

      var max = arr[0];
      var maxIndex = 0;

      for (var i = 1; i < arr.length; i++) {
         if (arr[i] > max) {
            maxIndex = i;
            max = arr[i];
         }
      }

      return maxIndex;
   }

   </script>
</body>
</html>